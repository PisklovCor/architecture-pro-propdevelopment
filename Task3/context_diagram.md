# Диаграмма контекста C4: Интеграция сервисов "Умный дом"

## Описание контекста

PropDevelopment расширяет функциональность мобильного приложения для собственников, добавляя два новых сервиса от внешнего партнёра:

1. **Интеллектуальный домофон** - видеодомофон с функцией распознавания лиц (биометрия) и автоматическим открытием двери
2. **Интеллектуальный шлагбаум** - автоматическое управление шлагбаумом с распознаванием номеров автомобилей

## Основные актёры и системы

### Актёры
- **Собственник недвижимости** - владелец квартиры, использующий мобильное приложение
- **Житель/Гость** - человек, которому предоставлен доступ собственником
- **Администратор УК** - сотрудник управляющей компании, управляющий настройками доступа

### Системы PropDevelopment
- **Мобильное приложение собственника** - существующее приложение для управления ЖКХ и умным домом
- **tenant-core-app** - backend-сервис для предоставления услуг собственникам
- **CRM (tenant)** - система управления данными собственников
- **Служба каталогов (LDAP/AD)** - система аутентификации и авторизации

### Внешние системы
- **Платформа "Умный дом" (Smart Home Platform)** - партнёрская платформа, предоставляющая сервисы умного домофона и шлагбаума
  - **API Gateway партнёра** - точка входа для интеграции
  - **Сервис биометрии** - распознавание лиц для домофона
  - **Сервис распознавания номеров** - распознавание автомобильных номеров
  - **Сервис управления устройствами** - управление домофонами и шлагбаумами
  - **База данных устройств** - хранилище данных об устройствах и правах доступа

## Взаимодействие между системами

### 1. Сценарий: Настройка доступа собственником

```
Собственник → Мобильное приложение → tenant-core-app → API Gateway партнёра → Smart Home Platform
```

**Действия:**
1. Собственник авторизуется в мобильном приложении
2. Открывает раздел "Умный дом" → "Управление доступом"
3. Добавляет фото жильца для биометрии домофона
4. Добавляет номер автомобиля для доступа к парковке
5. Устанавливает права доступа (временные/постоянные)

**Потоки данных:**
- Приложение → tenant-core-app: запрос на добавление доступа (с фото и номером авто)
- tenant-core-app → CRM: проверка прав собственника
- tenant-core-app → Служба каталогов: аутентификация и авторизация
- tenant-core-app → API Gateway партнёра: передача данных для регистрации доступа
- API Gateway → Сервис биометрии: обработка и сохранение биометрических данных
- API Gateway → Сервис распознавания номеров: регистрация номера автомобиля

### 2. Сценарий: Использование умного домофона

```
Житель → Домофон → Smart Home Platform → tenant-core-app → Уведомление в приложение
```

**Действия:**
1. Житель подходит к двери
2. Домофон сканирует лицо
3. Платформа распознаёт лицо и проверяет права доступа
4. При успешном распознавании - автоматически открывает дверь
5. При неудачном распознавании - отправляет видеозвонок собственнику

**Потоки данных:**
- Домофон → Smart Home Platform: изображение лица
- Smart Home Platform → Сервис биометрии: распознавание лица
- Smart Home Platform → tenant-core-app: запрос прав доступа (по ID жилого комплекса)
- tenant-core-app → Smart Home Platform: подтверждение прав доступа
- Smart Home Platform → Домофон: команда открытия двери
- Smart Home Platform → tenant-core-app: уведомление о событии
- tenant-core-app → Мобильное приложение: push-уведомление собственнику

### 3. Сценарий: Использование умного шлагбаума

```
Автомобиль → Шлагбаум → Smart Home Platform → tenant-core-app → Открытие шлагбаума
```

**Действия:**
1. Автомобиль подъезжает к шлагбауму
2. Камера считывает номер автомобиля
3. Платформа проверяет права доступа
4. При наличии прав - автоматически открывает шлагбаум

**Потоки данных:**
- Шлагбаум → Smart Home Platform: изображение номера
- Smart Home Platform → Сервис распознавания номеров: распознавание номера
- Smart Home Platform → tenant-core-app: запрос прав доступа
- tenant-core-app → Smart Home Platform: подтверждение прав
- Smart Home Platform → Шлагбаум: команда открытия
- Smart Home Platform → tenant-core-app: уведомление о событии

### 4. Сценарий: Просмотр истории событий

```
Собственник → Мобильное приложение → tenant-core-app → API Gateway партнёра → История событий
```

**Действия:**
1. Собственник открывает историю событий в приложении
2. Просматривает список проходов через домофон и парковку
3. Получает доступ к видеозаписям с домофона

**Потоки данных:**
- Приложение → tenant-core-app: запрос истории событий
- tenant-core-app → API Gateway партнёра: запрос событий
- API Gateway → tenant-core-app: список событий
- tenant-core-app → Приложение: отображение истории

## Границы системы

### Внутри периметра PropDevelopment:
- Мобильное приложение собственников
- tenant-core-app
- CRM (tenant)
- crm-tenant-db
- Служба каталогов (LDAP/AD)
- Инфраструктура (firewall, сеть)

### Вне периметра PropDevelopment (партнёрская система):
- API Gateway партнёра
- Сервис биометрии
- Сервис распознавания номеров
- Сервис управления устройствами
- База данных устройств
- Физические устройства (домофоны, шлагбаумы)

## Точки интеграции

### Основная точка интеграции:
**tenant-core-app ↔ API Gateway партнёра**

Через эту точку проходят все запросы:
- Управление доступом (добавление/удаление прав)
- Проверка прав доступа в реальном времени
- Получение событий и уведомлений
- Получение истории событий
- Управление устройствами

### Протоколы взаимодействия:
- **REST API** - основной протокол для запросов
- **WebSocket/Server-Sent Events** - для получения событий в реальном времени
- **OAuth 2.0** - для аутентификации и авторизации
- **HTTPS/TLS 1.3** - для шифрования трафика

## Требования к контексту

### Функциональные требования:
1. Интеграция должна быть прозрачной для собственников
2. Время отклика на проверку доступа не должно превышать 2 секунд
3. Система должна работать в режиме 24/7 с доступностью 99.9%
4. История событий должна храниться не менее 6 месяцев

### Нефункциональные требования:
1. **Безопасность**: все данные передаются по защищенным каналам
2. **Производительность**: поддержка до 10000 одновременных проверок доступа
3. **Масштабируемость**: возможность добавления новых устройств без изменения архитектуры
4. **Отказоустойчивость**: при недоступности партнёрской платформы должен работать резервный механизм

### Требования к данным:
1. Биометрические данные должны храниться в зашифрованном виде
2. Персональные данные не должны покидать периметр без необходимости
3. Соответствие требованиям ФЗ-152 "О персональных данных"
4. Соответствие требованиям GDPR (при наличии европейских клиентов)

## Риски и ограничения

### Риски:
1. **Утечка биометрических данных** через партнёрскую систему
2. **Недоступность партнёрской платформы** - блокировка доступа жильцов
3. **Некорректное распознавание** - отказ в доступе легитимным пользователям
4. **Несанкционированный доступ** через уязвимости API партнёра
5. **Нарушение privacy** - доступ партнёра к данным других жилых комплексов

### Ограничения:
1. Зависимость от внешнего партнёра
2. Необходимость физической установки устройств в жилых комплексах
3. Требования к качеству интернет-соединения
4. Ограничения на хранение биометрических данных
