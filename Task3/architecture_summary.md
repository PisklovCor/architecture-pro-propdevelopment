# Краткая сводка архитектурных решений: Интеграция "Умный дом"

## Новые компоненты системы

| Компонент | Технология | Назначение | Безопасность |
|-----------|------------|------------|--------------|
| **smart-home-integration-service** | Kotlin, Spring Boot | API Gateway для интеграции с партнёром. Управление токенами, трансформация данных, Circuit Breaker | OAuth 2.0, mTLS, Rate Limiting |
| **smart-home-db** | PostgreSQL | Кэш прав доступа и маппинг ID для fallback режима | Шифрование колонок (AES-256-GCM) |
| **event-processor-service** | Kotlin, Spring Boot | Асинхронная обработка событий от устройств, отправка уведомлений | Проверка подписи webhooks (HMAC-SHA256) |
| **Message Broker** | RabbitMQ/Kafka | Очередь событий для асинхронной обработки | TLS для всех соединений |
| **API Gateway (internal)** | Kong/Nginx | Маршрутизация запросов, балансировка нагрузки | WAF, IP Whitelisting |

## Внешние системы (Партнёр)

| Система | Технология | Функция | Интеграция |
|---------|------------|---------|------------|
| **API Gateway партнёра** | - | Точка входа для всех запросов | REST API, OAuth 2.0, TLS 1.3 |
| **Сервис биометрии** | Python, TensorFlow | Распознавание лиц | gRPC (внутри партнёра) |
| **Сервис распознавания номеров** | Python, OpenCV | Распознавание автомобильных номеров | gRPC (внутри партнёра) |
| **Сервис управления устройствами** | Go, gRPC | Управление домофонами и шлагбаумами | MQTT/TLS (устройства ↔ сервис) |
| **База устройств** | MongoDB | Хранение данных устройств и прав доступа | Managed by partner |

## Протоколы и стандарты

### Аутентификация и авторизация

| Механизм | Применение | Параметры |
|----------|------------|-----------|
| **OAuth 2.0** | PropDevelopment ↔ Партнёр | Client Credentials Flow, JWT (RS256), 15 мин lifetime |
| **mTLS** | Критические операции (биометрия) | TLS 1.3, X.509 сертификаты, ротация 30 дней |
| **API Keys** | Дополнительная идентификация | UUID v4, X-API-Key header, ротация 180 дней |
| **Scopes** | Разграничение доступа | 8 scopes (read/write для devices, access, biometry, plates, events) |

### Передача данных

| Протокол | Применение | Безопасность |
|----------|------------|--------------|
| **HTTPS/REST** | Основной протокол API | TLS 1.3, Perfect Forward Secrecy |
| **WebSocket/SSE** | Получение событий в реальном времени | WSS (WebSocket Secure) |
| **Webhooks** | Уведомления от партнёра | HMAC-SHA256 подпись, IP Whitelisting |
| **MQTT/TLS** | Устройства ↔ Партнёр | MQTT over TLS, клиентские сертификаты |

## Архитектурные паттерны

| Паттерн | Цель | Реализация |
|---------|------|------------|
| **API Gateway** | Централизация запросов | smart-home-integration-service |
| **Circuit Breaker** | Защита от каскадных отказов | Resilience4j, fallback на кэш |
| **Event-Driven** | Асинхронная обработка | RabbitMQ/Kafka + event-processor |
| **Saga** | Распределённые транзакции | Choreography-based, компенсирующие транзакции |
| **Envelope Encryption** | Защита данных | DEK (данные) + KEK (ключи в KMS) |
| **Retry with Backoff** | Обработка ошибок | Exponential backoff, max 5 попыток |

## Основные потоки данных

### 1. Создание права доступа

```
Собственник (Mobile App)
    ↓ HTTPS
tenant-core-app
    ↓ REST
smart-home-integration-service
    ↓ OAuth 2.0, mTLS, HTTPS
API Gateway партнёра
    ↓ gRPC (internal)
Сервис биометрии
    ↓
База устройств
```

### 2. Проверка доступа (реальное время)

```
Житель → Домофон (биометрия)
    ↓ MQTT/TLS
Сервис управления устройствами
    ↓ gRPC
Сервис биометрии (распознавание)
    ↓ REST
smart-home-integration-service (проверка прав)
    ↓
Решение: Открыть/Отказать
```

### 3. Обработка события (асинхронно)

```
API Gateway партнёра (webhook)
    ↓ HTTPS + HMAC signature
smart-home-integration-service
    ↓ AMQP
Message Broker (RabbitMQ/Kafka)
    ↓
event-processor-service
    ↓ REST
tenant-core-app
    ↓ FCM/APNS
Mobile App (Push-уведомление)
```

## Меры безопасности

### Защита от угроз из Task1

| Проблема (Task1) | Угроза | Решение (Task3) |
|------------------|--------|-----------------|
| Партнёры видят данные других УК | Утечка ПДн, нарушение изоляции | building_id в JWT, проверка контекста на каждом запросе, отдельные API-ключи |
| Контракты API содержат избыточные ПДн | Избыточная передача данных | Scopes, минимизация данных, псевдонимизация ID |
| Нет контроля передаваемых данных | Утечка, искажение | Централизованное логирование, SIEM, Distributed Tracing |
| Нет единых политик безопасности | Разнородные уязвимости | Единый документ требований, обязательный для всех интеграций |

### Защита секретных данных (биометрия)

| Этап | Защита |
|------|--------|
| **Захват (устройство)** | Локальная обработка → face encoding |
| **Передача (App → Backend)** | TLS 1.3, шифрование face encoding |
| **Обработка (Backend)** | Псевдонимизация user_id, re-encryption для партнёра |
| **Передача (Backend → Партнёр)** | mTLS, OAuth 2.0, HTTPS |
| **Хранение (БД)** | AES-256-GCM, Envelope Encryption, KMS |
| **Логирование** | Хэш изображения (SHA-256), НЕ сами данные биометрии |

## Метрики и SLA

| Метрика | Целевое значение | Метод измерения |
|---------|------------------|-----------------|
| **Uptime** | 99.9% (43.2 мин/месяц) | Prometheus + health checks |
| **Latency (p95)** | < 2 сек (проверка доступа) | Distributed Tracing |
| **Error Rate** | < 0.1% | Мониторинг HTTP 5xx |
| **Rate Limit** | 1000 req/min (global), 100 req/min (per building) | API Gateway |
| **RTO** | 4 часа | Disaster Recovery план |
| **RPO** | 24 часа | Резервное копирование |

## Мониторинг и аудит

| Система | Цель | Retention |
|---------|------|-----------|
| **ELK Stack** | Централизованные логи | Application: 90 дней, Audit: 1 год |
| **Prometheus + Grafana** | Метрики производительности | Real-time + 30 дней история |
| **SIEM (Splunk/Wazuh)** | Обнаружение инцидентов | 1 год |
| **Jaeger/Zipkin** | Distributed Tracing | 7 дней |
| **Backup** | Восстановление данных | 30 дней / 3 месяца / 1 год |

## Сценарии отказоустойчивости

| Сценарий | Fallback | Восстановление |
|----------|----------|----------------|
| **Партнёр недоступен** | Кэш в smart-home-db (24 часа) | Синхронизация при восстановлении |
| **Circuit Breaker Open** | Блокировка новых запросов, использование кэша | Half-Open через 30 сек |
| **Timeout** | Retry с exponential backoff (max 5) | - |
| **Token expired** | Автоматическое обновление через refresh token | - |
| **Webhook не доставлен** | Retry с backoff, Dead Letter Queue | Manual replay |
| **Сервис упал** | Автоматический перезапуск, балансировщик на здоровый инстанс | Kubernetes/Docker health checks |

## Соответствие стандартам

| Стандарт | Требования | Реализация |
|----------|------------|------------|
| **ФЗ-152** | Защита ПДн | Шифрование, изоляция, аудит, уведомления о нарушениях |
| **ISO 27001/27002** | Управление ИБ | Документированные процедуры, контроли, риск-анализ |
| **ФСТЭК** | Защита информации | Многоуровневая защита, сегментация сети, аудит |
| **GDPR** (если применимо) | Privacy by Design | Минимизация данных, псевдонимизация, право на забвение |

## Команды и ответственность

| Роль | Ответственность | Контакт |
|------|----------------|---------|
| **CISO** | Стратегия ИБ, инциденты P0-P1 | ciso@propdevelopment.com |
| **SOC (24/7)** | Мониторинг, реагирование на инциденты | security-ops@propdevelopment.com |
| **Smart Home Tech Lead** | Архитектура интеграции, техническая эскалация | smarthome-lead@propdevelopment.com |
| **DevOps** | Инфраструктура, деплой, мониторинг | devops@propdevelopment.com |
| **Партнёр Security Team** | Безопасность платформы, координация инцидентов | security@partner-smarthome.com |

## Дорожная карта внедрения

| Этап | Сроки | Задачи |
|------|-------|--------|
| **1. Подготовка** | 2 недели | Согласование с партнёром, подписание DPA, выделение ресурсов |
| **2. Разработка** | 6 недель | Реализация smart-home-integration-service, event-processor, настройка инфраструктуры |
| **3. Тестирование** | 3 недели | Функциональное, нагрузочное, penetration testing |
| **4. Пилот** | 4 недели | Внедрение в 1 жилом комплексе, сбор метрик, исправление ошибок |
| **5. Масштабирование** | 12 недель | Постепенное внедрение в остальных жилых комплексах |
| **6. Аудит** | 2 недели | Аудит безопасности, проверка соответствия требованиям |

**Общий срок:** ~6 месяцев от начала до полного внедрения

---

**Итого:**
- **3 новых сервиса** (smart-home-integration, event-processor, message broker)
- **50+ требований безопасности** (охватывают все аспекты интеграции)
- **4 архитектурных паттерна** (API Gateway, Circuit Breaker, EDA, Saga)
- **99.9% SLA** (высокая доступность)
- **Полное соответствие** ФЗ-152, ISO 27001/27002, ФСТЭК