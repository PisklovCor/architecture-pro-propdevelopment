# Требования к безопасности внешних интеграций: Платформа "Умный дом"

## Содержание
1. [Введение](#введение)
2. [Общие требования безопасности](#общие-требования-безопасности)
3. [Аутентификация и авторизация](#аутентификация-и-авторизация)
4. [Организация взаимодействия между системами](#организация-взаимодействия-между-системами)
5. [Требования к защите данных](#требования-к-защите-данных)
6. [Требования к мониторингу и аудиту](#требования-к-мониторингу-и-аудиту)
7. [Требования к обеспечению доступности](#требования-к-обеспечению-доступности)
8. [Требования к управлению инцидентами](#требования-к-управлению-инцидентами)

---

## Введение

### Цель документа
Данный документ определяет требования к безопасности при интеграции систем PropDevelopment с внешней платформой партнёра "Умный дом", предоставляющей сервисы интеллектуального домофона и умного шлагбаума.

### Область применения
Требования распространяются на:
- Интеграцию между **tenant-core-app** (PropDevelopment) и **API Gateway партнёра**
- Новый сервис **smart-home-integration-service**
- Новый сервис **event-processor-service**
- Все компоненты, участвующие в передаче данных между системами

### Нормативные документы
- ФЗ-152 "О персональных данных"
- ФЗ-149 "Об информации, информационных технологиях и о защите информации"
- Требования ФСТЭК России по защите информации
- ISO/IEC 27001:2013 - Система управления информационной безопасностью
- ISO/IEC 27002:2013 - Свод практических правил
- PCI DSS (при обработке платёжных данных)
- ГОСТ Р 57580.1-2017 "Безопасность финансовых (банковских) операций"

### Классификация данных
Согласно проведённому анализу безопасности (Task1), в рамках интеграции обрабатываются следующие категории данных:

| Категория | Примеры данных | Риски | Уровень риска |
|-----------|----------------|-------|---------------|
| **Секретные** | Биометрические данные (фото лиц), коды доступа к квартирам, ключи шифрования, токены доступа | Утечка, искажение | Критический |
| **Конфиденциальные** | ПДн собственников, номера автомобилей, данные о правах доступа, история проходов | Утечка, искажение | Критический |
| **Внутренние** | Логи событий, технические метаданные, статистика использования | Утечка, потеря | Значительный |

---

## Общие требования безопасности

### REQ-SEC-001: Принцип минимальных привилегий
**Приоритет:** Критический
**Описание:** Партнёрская система должна получать доступ только к данным, необходимым для выполнения конкретных функций.

**Требования:**
1. API партнёра **НЕ ДОЛЖНО** получать доступ к данным других жилых комплексов
2. Каждый запрос **ДОЛЖЕН** содержать контекст жилого комплекса (building_id)
3. Партнёр **НЕ ДОЛЖЕН** иметь возможность читать полные профили собственников
4. Передача данных **ДОЛЖНА** ограничиваться минимально необходимым набором:
   - Для регистрации доступа: ID пользователя, хэш биометрии, номер авто, права доступа, срок действия
   - Для проверки доступа: ID пользователя или хэш биометрии/номера
   - Для событий: ID устройства, тип события, временная метка

**Контроль:**
- Аудит всех API-запросов на соответствие контексту
- Регулярная проверка логов на попытки доступа к чужим данным

### REQ-SEC-002: Изоляция данных (Data Isolation)
**Приоритет:** Критический
**Описание:** Данные разных жилых комплексов и управляющих компаний должны быть строго изолированы.

**Требования:**
1. На уровне API Gateway должна быть реализована проверка принадлежности данных к запрашивающему контексту
2. Партнёр должен использовать отдельные API-ключи для каждого жилого комплекса
3. В базе данных партнёра должна быть реализована многопользовательская архитектура (multi-tenancy)
4. Каждый запрос должен проходить валидацию на соответствие контексту вызывающей стороны

**Контроль:**
- Пентест на проверку изоляции данных
- Аудит архитектуры базы данных партнёра

### REQ-SEC-003: Безопасность по умолчанию (Secure by Default)
**Приоритет:** Высокий
**Описание:** Все компоненты интеграции должны быть настроены на максимальный уровень безопасности.

**Требования:**
1. Все недокументированные эндпоинты должны быть отключены
2. Дефолтные credentials должны быть изменены
3. Режим отладки должен быть отключён в production
4. Все неиспользуемые порты и сервисы должны быть закрыты
5. Применяется принцип "запретить всё, разрешить необходимое"

### REQ-SEC-004: Глубокая защита (Defense in Depth)
**Приоритет:** Высокий
**Описание:** Защита должна быть реализована на всех уровнях архитектуры.

**Уровни защиты:**
1. **Сетевой уровень:** Firewall, IPS/IDS, сегментация сети
2. **Периметр приложения:** API Gateway, WAF, rate limiting
3. **Уровень приложения:** Аутентификация, авторизация, валидация входных данных
4. **Уровень данных:** Шифрование, маскирование, контроль доступа
5. **Мониторинг:** SIEM, анализ логов, обнаружение аномалий

---

## Аутентификация и авторизация

### REQ-AUTH-001: Протокол OAuth 2.0
**Приоритет:** Критический
**Описание:** Для аутентификации и авторизации между системами используется протокол OAuth 2.0.

**Параметры реализации:**
- **Grant Type:** Client Credentials Flow (machine-to-machine)
- **Альтернатива:** Authorization Code Flow with PKCE (для делегирования доступа собственника)
- **Token Type:** JWT (JSON Web Token)
- **Token Lifetime:** Access Token - 15 минут, Refresh Token - 7 дней
- **Алгоритм подписи:** RS256 (RSA with SHA-256)

**Схема взаимодействия:**
```
1. smart-home-integration-service → Authorization Server партнёра
   POST /oauth/token
   {
     "grant_type": "client_credentials",
     "client_id": "{client_id}",
     "client_secret": "{client_secret}",
     "scope": "smart_home.devices.read smart_home.devices.write smart_home.events.read"
   }

2. Authorization Server → smart-home-integration-service
   {
     "access_token": "{jwt_token}",
     "token_type": "Bearer",
     "expires_in": 900,
     "scope": "smart_home.devices.read smart_home.devices.write"
   }

3. smart-home-integration-service → API Gateway партнёра
   GET /api/v1/devices
   Authorization: Bearer {jwt_token}
   X-Building-Context: {building_id}
```

**Требования к JWT:**
- **Header:** {"alg": "RS256", "typ": "JWT"}
- **Payload (обязательные claims):**
  - `iss` (issuer) - идентификатор партнёра
  - `sub` (subject) - идентификатор клиента (PropDevelopment)
  - `aud` (audience) - целевая система
  - `exp` (expiration) - время истечения токена
  - `iat` (issued at) - время выдачи
  - `jti` (JWT ID) - уникальный идентификатор токена
  - `scope` - разрешения (scopes)
  - `building_id` - контекст жилого комплекса

**Управление ключами:**
- Ротация секретов каждые 90 дней (автоматическая)
- Хранение client_secret в защищённом хранилище (HashiCorp Vault, AWS Secrets Manager)
- Публичные ключи для проверки JWT размещаются на эндпоинте `/.well-known/jwks.json`

### REQ-AUTH-002: Взаимная TLS-аутентификация (mTLS)
**Приоритет:** Высокий
**Описание:** Для дополнительной защиты критических операций используется взаимная аутентификация на уровне TLS.

**Применение:**
- Все запросы на изменение прав доступа (создание, удаление)
- Передача биометрических данных
- Получение истории событий с конфиденциальными данными

**Требования:**
1. Оба участника (клиент и сервер) предоставляют сертификаты X.509
2. Сертификаты выданы доверенным центром сертификации (CA)
3. Проверка срока действия сертификатов
4. Проверка отзыва сертификатов (OCSP Stapling)
5. Срок действия сертификатов - не более 1 года
6. Автоматическая ротация сертификатов за 30 дней до истечения

**Параметры:**
- Версия TLS: 1.3 (минимум TLS 1.2)
- Cipher Suites: TLS_AES_256_GCM_SHA384, TLS_CHACHA20_POLY1305_SHA256
- Проверка: Required (обязательная проверка клиентского сертификата)

### REQ-AUTH-003: Scopes и разрешения
**Приоритет:** Высокий
**Описание:** Доступ к API разграничивается через систему scopes.

**Определённые scopes:**

| Scope | Описание | Разрешённые операции |
|-------|----------|---------------------|
| `smart_home.devices.read` | Чтение информации об устройствах | GET /api/v1/devices, GET /api/v1/devices/{id} |
| `smart_home.devices.write` | Управление устройствами | POST /api/v1/devices/{id}/control |
| `smart_home.access.read` | Чтение прав доступа | GET /api/v1/access-rights |
| `smart_home.access.write` | Управление правами доступа | POST /api/v1/access-rights, DELETE /api/v1/access-rights/{id} |
| `smart_home.biometry.write` | Регистрация биометрии | POST /api/v1/biometry |
| `smart_home.plates.write` | Регистрация номеров авто | POST /api/v1/vehicle-plates |
| `smart_home.events.read` | Чтение событий | GET /api/v1/events |
| `smart_home.events.subscribe` | Подписка на события | WebSocket /ws/events |

**Матрица доступа:**

| Сервис | Требуемые scopes |
|--------|------------------|
| smart-home-integration-service | `smart_home.access.read`, `smart_home.access.write`, `smart_home.biometry.write`, `smart_home.plates.write`, `smart_home.devices.read` |
| event-processor-service | `smart_home.events.read`, `smart_home.events.subscribe` |

### REQ-AUTH-004: API Keys для дополнительной идентификации
**Приоритет:** Средний
**Описание:** В дополнение к OAuth 2.0, используются API-ключи для идентификации источника запроса.

**Реализация:**
- API-ключ передаётся в заголовке `X-API-Key`
- Ключ генерируется для каждого жилого комплекса отдельно
- Формат: UUID v4 или случайная строка (256 бит энтропии)
- Хранение: хэш ключа (SHA-256) в базе данных
- Ротация: каждые 180 дней или при компрометации

**Пример:**
```
GET /api/v1/devices
Authorization: Bearer {jwt_token}
X-API-Key: a1b2c3d4-e5f6-7890-abcd-ef1234567890
X-Building-Context: building_12345
```

### REQ-AUTH-005: Проверка авторизации на уровне ресурсов
**Приоритет:** Критический
**Описание:** Каждый запрос проверяется на соответствие контексту запрашиваемого ресурса.

**Проверки:**
1. **Проверка токена:** валидность, срок действия, подпись
2. **Проверка scopes:** наличие необходимых разрешений
3. **Проверка контекста:** соответствие building_id в токене и в запросе
4. **Проверка принадлежности ресурса:** запрашиваемый ресурс принадлежит указанному building_id

**Алгоритм проверки:**
```
1. Извлечь JWT из заголовка Authorization
2. Проверить подпись JWT
3. Проверить срок действия (exp claim)
4. Извлечь building_id из JWT
5. Извлечь building_id из заголовка X-Building-Context
6. Проверить: JWT.building_id == Header.building_id
7. Извлечь ID запрашиваемого ресурса (например, device_id)
8. Запросить из БД: к какому building_id принадлежит device_id
9. Проверить: Resource.building_id == JWT.building_id
10. Проверить наличие требуемого scope для операции
11. Если все проверки пройдены → разрешить доступ
```

---

## Организация взаимодействия между системами

### REQ-INT-001: Архитектурные паттерны интеграции
**Приоритет:** Высокий
**Описание:** Определены архитектурные паттерны для взаимодействия с внешней платформой.

**Используемые паттерны:**

#### 1. API Gateway Pattern
**Назначение:** Централизованная точка входа для всех запросов к партнёрской платформе

**Компонент:** smart-home-integration-service (играет роль gateway между tenant-core-app и API партнёра)

**Функции:**
- Агрегация запросов
- Трансформация данных (адаптация форматов)
- Управление токенами (кэширование, обновление)
- Маршрутизация запросов
- Rate limiting и throttling
- Логирование и мониторинг

**Преимущества:**
- Изоляция tenant-core-app от изменений в API партнёра
- Централизованное управление безопасностью
- Возможность кэширования часто запрашиваемых данных

#### 2. Circuit Breaker Pattern
**Назначение:** Защита от каскадных отказов при недоступности партнёрской платформы

**Реализация:** Библиотека Resilience4j или Spring Cloud Circuit Breaker

**Параметры:**
- **Failure Threshold:** 50% (половина запросов завершается ошибкой)
- **Wait Duration in Open State:** 30 секунд
- **Ring Buffer Size in Half-Open State:** 10 запросов
- **Timeout:** 5 секунд на запрос

**Состояния:**
- **Closed:** Нормальная работа, запросы проходят
- **Open:** Платформа недоступна, запросы не отправляются, возвращается fallback
- **Half-Open:** Проверка восстановления, отправляется ограниченное число запросов

**Fallback стратегия:**
- Использование кэшированных данных прав доступа (из smart-home-db)
- Уведомление администратора о недоступности
- Логирование неуспешных операций для повторной обработки

#### 3. Event-Driven Architecture (EDA)
**Назначение:** Асинхронная обработка событий от партнёрской платформы

**Компоненты:**
- **Message Broker:** RabbitMQ или Apache Kafka
- **Publisher:** API Gateway партнёра (отправляет webhooks)
- **Consumer:** event-processor-service

**Типы событий:**
- `access.granted` - предоставлен доступ
- `access.denied` - отказ в доступе
- `device.status_changed` - изменение статуса устройства
- `biometry.recognized` - успешное распознавание лица
- `plate.recognized` - успешное распознавание номера
- `intercom.call` - видеозвонок с домофона

**Обработка событий:**
```
1. Webhook от партнёра → smart-home-integration-service
2. Валидация подписи webhook (HMAC SHA-256)
3. Публикация события в Message Broker
4. event-processor-service получает событие из очереди
5. Обогащение события данными из tenant-crm
6. Отправка уведомления в tenant-core-app
7. Отправка push-уведомления собственнику через FCM/APNS
```

**Гарантии доставки:**
- **At-least-once delivery:** событие может быть обработано несколько раз
- Идемпотентность обработчиков событий (использование event_id)
- Механизм retry с экспоненциальной задержкой (backoff)
- Dead Letter Queue для необработанных событий

#### 4. Saga Pattern (для распределённых транзакций)
**Назначение:** Обеспечение согласованности данных при операциях, затрагивающих обе системы

**Пример:** Добавление нового доступа

**Choreography-based Saga:**
```
1. tenant-core-app → smart-home-integration-service: Создать доступ
2. smart-home-integration-service → smart-home-db: Сохранить локально
3. smart-home-integration-service → API партнёра: Зарегистрировать биометрию
4. Если успех:
   a. API партнёра → event-processor: Событие "biometry.registered"
   b. event-processor → tenant-core-app: Уведомление об успехе
   c. tenant-core-app → mobile_app: Push "Доступ создан"
5. Если ошибка:
   a. smart-home-integration-service → smart-home-db: Откатить запись (компенсирующая транзакция)
   b. smart-home-integration-service → tenant-core-app: Уведомление об ошибке
   c. tenant-core-app → mobile_app: Push "Ошибка создания доступа"
```

### REQ-INT-002: Сетевая архитектура
**Приоритет:** Критический
**Описание:** Определена сетевая топология для безопасного взаимодействия.

**Сегментация сети:**

```
┌─────────────────────────────────────────────────────────────┐
│                      Internet (Untrusted)                    │
└────────────────────────┬────────────────────────────────────┘
                         │
                    ┌────▼────┐
                    │ Firewall│
                    │ (WAF)   │
                    └────┬────┘
                         │
        ┌────────────────┴────────────────┐
        │                                 │
   ┌────▼─────┐                    ┌─────▼────┐
   │   DMZ    │                    │Partner   │
   │          │                    │Webhook   │
   │API GW    │                    │Listener  │
   │(internal)│                    │          │
   └────┬─────┘                    └─────┬────┘
        │                                │
        │         ┌──────────────────────┘
        │         │
   ┌────▼─────────▼───────────────────────────────┐
   │      Application Zone (Internal Network)     │
   │                                               │
   │  ┌─────────────┐      ┌──────────────────┐  │
   │  │tenant-core  │      │smart-home-       │  │
   │  │    -app     │◄────►│integration-      │  │
   │  │             │      │service           │  │
   │  └─────────────┘      └────────┬─────────┘  │
   │                                 │            │
   │  ┌─────────────┐      ┌─────────▼─────────┐ │
   │  │event-       │◄─────│Message Broker     │ │
   │  │processor    │      │(RabbitMQ/Kafka)   │ │
   │  └─────────────┘      └───────────────────┘ │
   │                                              │
   └──────────────────────────────────────────────┘
                         │
   ┌─────────────────────▼──────────────────────┐
   │         Data Zone (Restricted)             │
   │                                             │
   │  ┌─────────────┐      ┌──────────────────┐ │
   │  │tenant-crm-db│      │smart-home-db     │ │
   │  └─────────────┘      └──────────────────┘ │
   │                                             │
   └─────────────────────────────────────────────┘
                         │
                    ┌────▼────┐
                    │Firewall │
                    │(Egress) │
                    └────┬────┘
                         │
                    ┌────▼────────────────┐
                    │Partner API Gateway  │
                    │(External, HTTPS/TLS)│
                    └─────────────────────┘
```

**Правила Firewall:**

**Ingress (входящий трафик):**
- Разрешён HTTPS (443) от мобильных приложений к DMZ (API Gateway)
- Разрешён HTTPS (443) от партнёра к Webhook Listener (только с IP-адресов партнёра - whitelist)
- Запрещён прямой доступ к Application Zone извне

**Internal (внутренний трафик):**
- Разрешён HTTP/HTTPS между сервисами в Application Zone
- Разрешён доступ к Message Broker только для event-processor и smart-home-integration
- Разрешён доступ к БД только для соответствующих сервисов

**Egress (исходящий трафик):**
- Разрешён HTTPS (443) от smart-home-integration-service к API партнёра (только на домен партнёра)
- Весь остальной исходящий трафик запрещён по умолчанию

**IP Whitelisting:**
- Партнёр предоставляет список статических IP-адресов для webhooks
- PropDevelopment предоставляет партнёру список IP-адресов для исходящих запросов
- Периодическая проверка актуальности списков (раз в квартал)

### REQ-INT-003: Форматы данных и контракты API
**Приоритет:** Высокий
**Описание:** Определены форматы обмена данными и версионирование API.

**Формат:** JSON (RFC 8259)
**Кодировка:** UTF-8
**Content-Type:** application/json

**Версионирование API:**
- **Стратегия:** URL Path Versioning
- **Формат:** `/api/v{major}/resource`
- **Пример:** `/api/v1/access-rights`, `/api/v2/access-rights`
- **Правило:** Major версия меняется при breaking changes

**Стандартная структура запроса:**
```json
{
  "request_id": "uuid-v4",
  "timestamp": "2025-10-20T10:30:00Z",
  "building_id": "building_12345",
  "data": {
    // специфичные данные запроса
  }
}
```

**Стандартная структура ответа (успех):**
```json
{
  "request_id": "uuid-v4",
  "status": "success",
  "timestamp": "2025-10-20T10:30:01Z",
  "data": {
    // данные ответа
  }
}
```

**Стандартная структура ответа (ошибка):**
```json
{
  "request_id": "uuid-v4",
  "status": "error",
  "timestamp": "2025-10-20T10:30:01Z",
  "error": {
    "code": "ACCESS_DENIED",
    "message": "Insufficient permissions to access this resource",
    "details": [
      {
        "field": "building_id",
        "issue": "Building does not belong to this tenant"
      }
    ]
  }
}
```

**HTTP Status Codes:**
- `200 OK` - успешное выполнение
- `201 Created` - ресурс создан
- `204 No Content` - успешное удаление
- `400 Bad Request` - некорректный запрос (валидация не прошла)
- `401 Unauthorized` - не авторизован (отсутствует или невалидный токен)
- `403 Forbidden` - запрещено (недостаточно прав)
- `404 Not Found` - ресурс не найден
- `429 Too Many Requests` - превышен лимит запросов
- `500 Internal Server Error` - внутренняя ошибка сервера
- `503 Service Unavailable` - сервис временно недоступен

**Пример API endpoint: Создание права доступа**

**Request:**
```http
POST /api/v1/access-rights HTTP/1.1
Host: partner-api.smarthome.example.com
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
X-API-Key: a1b2c3d4-e5f6-7890-abcd-ef1234567890
X-Building-Context: building_12345
Content-Type: application/json

{
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2025-10-20T10:30:00Z",
  "building_id": "building_12345",
  "data": {
    "user_id": "user_67890",
    "access_type": "biometric",
    "biometry_data": {
      "face_image_hash": "sha256:abcdef1234567890...",
      "face_encoding": "encrypted_base64_encoded_data..."
    },
    "device_ids": ["device_intercom_001", "device_intercom_002"],
    "permissions": {
      "auto_open": true,
      "time_restrictions": {
        "enabled": true,
        "allowed_hours": {
          "start": "06:00",
          "end": "23:00"
        },
        "allowed_days": ["monday", "tuesday", "wednesday", "thursday", "friday"]
      }
    },
    "valid_from": "2025-10-20T00:00:00Z",
    "valid_until": "2026-10-20T23:59:59Z"
  }
}
```

**Response:**
```http
HTTP/1.1 201 Created
Content-Type: application/json

{
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "success",
  "timestamp": "2025-10-20T10:30:02Z",
  "data": {
    "access_right_id": "access_right_abcd1234",
    "status": "active",
    "created_at": "2025-10-20T10:30:02Z",
    "devices_registered": 2
  }
}
```

### REQ-INT-004: Rate Limiting и Throttling
**Приоритет:** Высокий
**Описание:** Ограничение частоты запросов для защиты от перегрузки и DDoS.

**Лимиты для PropDevelopment (как клиента):**
- **Глобальный лимит:** 1000 запросов в минуту
- **Per Building ID:** 100 запросов в минуту
- **Burst:** До 150 запросов в течение 10 секунд

**Лимиты для партнёра (входящие webhooks):**
- **Глобальный лимит:** 500 webhooks в минуту
- **Per Event Type:** 100 событий в минуту

**HTTP Headers при достижении лимита:**
```http
HTTP/1.1 429 Too Many Requests
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1634728860
Retry-After: 60

{
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Rate limit exceeded. Please retry after 60 seconds."
  }
}
```

**Стратегия retry на стороне PropDevelopment:**
- Экспоненциальная задержка (exponential backoff): 1s, 2s, 4s, 8s, 16s
- Максимальное количество попыток: 5
- Jitter (случайная задержка) для предотвращения thundering herd

### REQ-INT-005: Webhook безопасность
**Приоритет:** Критический
**Описание:** Защита webhook endpoint от поддельных запросов.

**Механизм проверки подписи:**

**Генерация подписи (на стороне партнёра):**
```
1. Секретный ключ (shared secret): webhook_secret_key (256 бит)
2. Payload: JSON-тело webhook
3. Подпись: HMAC-SHA256(webhook_secret_key, payload)
4. Отправка в заголовке: X-Webhook-Signature: sha256={hex(подпись)}
```

**Проверка подписи (на стороне PropDevelopment):**
```python
import hmac
import hashlib

def verify_webhook_signature(payload, signature_header, secret):
    expected_signature = hmac.new(
        secret.encode('utf-8'),
        payload.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()

    received_signature = signature_header.replace('sha256=', '')

    return hmac.compare_digest(expected_signature, received_signature)

# Использование:
is_valid = verify_webhook_signature(request.body, request.headers['X-Webhook-Signature'], WEBHOOK_SECRET)

if not is_valid:
    return HTTP 401 Unauthorized
```

**Дополнительные проверки:**
- **Timestamp проверка:** Отклонять события старше 5 минут (защита от replay attacks)
- **Идемпотентность:** Использовать `event_id` для предотвращения дублирующей обработки
- **IP Whitelisting:** Принимать webhooks только с IP-адресов партнёра

**Структура webhook:**
```json
{
  "event_id": "evt_1234567890",
  "event_type": "access.granted",
  "timestamp": "2025-10-20T10:35:00Z",
  "building_id": "building_12345",
  "data": {
    "device_id": "device_intercom_001",
    "user_id": "user_67890",
    "access_method": "biometric_face",
    "confidence_score": 0.98
  }
}
```

**HTTP Headers:**
```http
POST /webhooks/smart-home/events HTTP/1.1
Host: webhook-listener.propdevelopment.com
Content-Type: application/json
X-Webhook-Signature: sha256=abc123def456...
X-Event-Type: access.granted
X-Event-ID: evt_1234567890
X-Timestamp: 1634728800
```

### REQ-INT-006: Таймауты и обработка ошибок
**Приоритет:** Высокий
**Описание:** Определены таймауты для всех операций и стратегии обработки ошибок.

**Таймауты:**
- **Connection Timeout:** 3 секунды
- **Read Timeout:** 10 секунд
- **Write Timeout:** 5 секунд
- **Idle Connection Timeout:** 60 секунд

**Стратегия retry:**

| Тип ошибки | HTTP Status | Retry | Backoff | Max Attempts |
|------------|-------------|-------|---------|--------------|
| Сетевая ошибка | - | Да | Exponential | 3 |
| Server Error | 500, 502, 503 | Да | Exponential | 3 |
| Таймаут | 504 | Да | Exponential | 3 |
| Rate Limit | 429 | Да | Retry-After header | 2 |
| Unauthorized | 401 | Да (обновить токен) | - | 1 |
| Bad Request | 400 | Нет | - | 0 |
| Forbidden | 403 | Нет | - | 0 |
| Not Found | 404 | Нет | - | 0 |

**Exponential Backoff:**
```
Попытка 1: 0 секунд
Попытка 2: 1 секунда + jitter(0-1s)
Попытка 3: 2 секунды + jitter(0-2s)
Попытка 4: 4 секунды + jitter(0-4s)
```

---

## Требования к защите данных

### REQ-DATA-001: Шифрование данных при передаче
**Приоритет:** Критический
**Описание:** Все данные, передаваемые между системами, должны быть зашифрованы.

**Требования:**
- **Протокол:** TLS 1.3 (минимум TLS 1.2)
- **Cipher Suites (рекомендуемые):**
  - TLS_AES_256_GCM_SHA384
  - TLS_CHACHA20_POLY1305_SHA256
  - TLS_AES_128_GCM_SHA256
- **Запрещённые Cipher Suites:**
  - Все с использованием RC4, DES, 3DES
  - Все с NULL encryption
  - Все с анонимной аутентификацией (ADH, AECDH)
- **Perfect Forward Secrecy (PFS):** Обязательно (использование ECDHE/DHE)
- **Сертификаты:** RSA 2048-bit или ECC 256-bit
- **HSTS:** Strict-Transport-Security: max-age=31536000; includeSubDomains; preload

**Проверка конфигурации:**
- Регулярное сканирование на SSL Labs (оценка A или выше)
- Отключение SSLv2, SSLv3, TLS 1.0, TLS 1.1

### REQ-DATA-002: Шифрование данных в покое
**Приоритет:** Критический
**Описание:** Секретные и конфиденциальные данные должны храниться в зашифрованном виде.

**Данные, требующие шифрования:**
- Биометрические данные (face encodings)
- Коды доступа к квартирам
- Токены доступа и refresh токены
- API ключи и секреты

**Требования:**
- **Алгоритм:** AES-256-GCM или ChaCha20-Poly1305
- **Управление ключами:** Использование KMS (Key Management Service)
  - AWS KMS, Azure Key Vault, HashiCorp Vault
- **Ротация ключей:** Автоматическая ротация каждые 90 дней
- **Envelope Encryption:**
  - Data Encryption Key (DEK) шифрует данные
  - Key Encryption Key (KEK) шифрует DEK
  - KEK хранится в KMS

**Шифрование на уровне БД:**
- **PostgreSQL:** pgcrypto extension или Transparent Data Encryption (TDE)
- **Колонки для шифрования:**
  - `smart_home_db.access_rights.biometry_data_encrypted`
  - `smart_home_db.access_rights.access_code_encrypted`
  - `smart_home_db.tokens.refresh_token_encrypted`

**Пример (псевдокод):**
```python
# Шифрование биометрических данных
def encrypt_biometry(face_encoding, building_id):
    # Получаем DEK для данного building_id из KMS
    dek = kms_client.get_data_key(key_id=f"dek-{building_id}")

    # Шифруем данные с помощью AES-256-GCM
    cipher = AES.new(dek.plaintext, AES.MODE_GCM)
    ciphertext, tag = cipher.encrypt_and_digest(face_encoding)

    # Сохраняем зашифрованный DEK и ciphertext
    return {
        "encrypted_dek": dek.ciphertext_blob,  # Зашифрованный DEK (через KEK)
        "ciphertext": base64.encode(ciphertext),
        "nonce": base64.encode(cipher.nonce),
        "tag": base64.encode(tag)
    }
```

### REQ-DATA-003: Минимизация данных
**Приоритет:** Высокий
**Описание:** Передавать и хранить только минимально необходимые данные.

**Принципы:**
1. **Не передавать полные фото лиц** - передавать только хэш и векторное представление (face encoding)
2. **Не передавать полные профили пользователей** - только ID пользователя и минимальные атрибуты
3. **Маскирование номеров автомобилей в логах** - логировать только последние 4 символа
4. **Удаление временных доступов** - автоматическое удаление истёкших прав доступа через 30 дней

**Обработка биометрии:**
```
Собственник загружает фото → Мобильное приложение

1. Локальная обработка на устройстве (если возможно):
   - Извлечение face encoding (128-мерный вектор)
   - Генерация хэша изображения (SHA-256)

2. Передача в tenant-core-app:
   - face_encoding (encrypted)
   - face_image_hash
   - НЕ передаётся: оригинальное изображение

3. Передача в API партнёра:
   - face_encoding (re-encrypted с ключом партнёра)
   - user_id (псевдоним, не реальный ID из CRM)
```

### REQ-DATA-004: Псевдонимизация и анонимизация
**Приоритет:** Высокий
**Описание:** Использование псевдонимов для идентификации пользователей вне периметра PropDevelopment.

**Маппинг ID:**
```
Внутренний ID (PropDevelopment) → Внешний ID (Партнёр)
user_12345 (CRM ID) → ext_user_a1b2c3d4e5f6 (псевдоним)
```

**Генерация псевдонимов:**
```python
import hashlib
import hmac

def generate_external_user_id(internal_user_id, secret_salt):
    # HMAC гарантирует, что только PropDevelopment может восстановить связь
    hmac_digest = hmac.new(
        secret_salt.encode('utf-8'),
        internal_user_id.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()

    return f"ext_user_{hmac_digest[:16]}"
```

**Таблица маппинга (хранится только в PropDevelopment):**
```sql
CREATE TABLE user_id_mapping (
    internal_user_id VARCHAR(255) PRIMARY KEY,
    external_user_id VARCHAR(255) UNIQUE NOT NULL,
    building_id VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_external_user_id ON user_id_mapping(external_user_id);
```

**Преимущества:**
- Партнёр не знает реальных ID пользователей PropDevelopment
- При компрометации данных партнёра невозможно сразу идентифицировать пользователей
- Соответствие принципу минимизации данных (GDPR, ФЗ-152)

### REQ-DATA-005: Логирование и маскирование конфиденциальных данных
**Приоритет:** Высокий
**Описание:** Логи не должны содержать секретные и конфиденциальные данные в открытом виде.

**Правила логирования:**

**НЕ логировать:**
- Биометрические данные
- Пароли и хэши паролей
- Токены доступа (access_token, refresh_token)
- API ключи и секреты
- Коды доступа к квартирам
- Полные номера автомобилей

**Логировать с маскированием:**
- Номера автомобилей: `A123BC***` (только первые 6 символов)
- Внутренние ID пользователей: `user_****2345` (только последние 4 цифры)
- Токены: `eyJhbG...***...**KFQ` (только первые и последние 6 символов)

**Логировать полностью:**
- Request ID
- Timestamp
- User Agent
- IP-адрес (с учётом GDPR - может требоваться маскирование)
- HTTP метод и URL (без query parameters с конфиденциальными данными)
- HTTP status code
- Response time
- Error messages (без конфиденциальных данных)

**Пример логирования:**
```json
{
  "timestamp": "2025-10-20T10:35:45.123Z",
  "level": "INFO",
  "service": "smart-home-integration-service",
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "method": "POST",
  "path": "/api/v1/access-rights",
  "status": 201,
  "duration_ms": 245,
  "user_id": "user_****2345",
  "building_id": "building_12345",
  "device_id": "device_intercom_001",
  "ip_address": "192.168.1.***",
  "user_agent": "PropDevelopment-Mobile-App/2.5.0"
}
```

### REQ-DATA-006: Резервное копирование и восстановление
**Приоритет:** Высокий
**Описание:** Обеспечение сохранности данных через резервное копирование.

**Требования:**
- **Частота:** Ежедневное инкрементальное копирование, еженедельное полное
- **Retention:**
  - Ежедневные бэкапы: хранить 30 дней
  - Еженедельные бэкапы: хранить 3 месяца
  - Ежемесячные бэкапы: хранить 1 год
- **Шифрование бэкапов:** AES-256
- **Географическая репликация:** Бэкапы хранятся в другом регионе/ЦОД
- **RTO (Recovery Time Objective):** 4 часа
- **RPO (Recovery Point Objective):** 24 часа

**Тестирование восстановления:**
- Ежеквартальные тесты восстановления из бэкапа
- Документирование процедуры восстановления
- Runbook для критических сценариев

---

## Требования к мониторингу и аудиту

### REQ-MON-001: Централизованное логирование
**Приоритет:** Высокий
**Описание:** Все компоненты интеграции отправляют логи в централизованную систему.

**Архитектура логирования:**
```
Сервисы → Логирование → Log Aggregator (Fluentd/Logstash) → SIEM/ELK Stack
```

**Что логируется:**
- Все API-запросы (входящие и исходящие)
- Успешные и неуспешные попытки аутентификации
- Изменения прав доступа (создание, изменение, удаление)
- События от устройств (проходы, отказы в доступе)
- Ошибки и исключения
- Изменения конфигурации
- Аномальная активность (подозрительные паттерны)

**Формат логов:** JSON structured logging

**Retention период:**
- Логи безопасности (audit logs): 1 год
- Логи приложений: 90 дней
- Логи событий устройств: 6 месяцев

### REQ-MON-002: Мониторинг метрик
**Приоритет:** Высокий
**Описание:** Непрерывный мониторинг ключевых метрик интеграции.

**Инструменты:** Prometheus + Grafana

**Метрики:**

**Производительность:**
- Latency: p50, p95, p99 время ответа API
- Throughput: количество запросов в секунду
- Error rate: процент ошибочных ответов (4xx, 5xx)
- Response time по эндпоинтам

**Доступность:**
- Uptime партнёрской платформы
- Uptime smart-home-integration-service
- Статус Circuit Breaker (closed/open/half-open)

**Безопасность:**
- Количество неуспешных попыток аутентификации
- Количество запросов с невалидными токенами
- Количество запросов, заблокированных Rate Limiter
- Подозрительные паттерны доступа (аномалии)

**Бизнес-метрики:**
- Количество созданных прав доступа
- Количество успешных/неуспешных проходов
- Количество видеозвонков с домофонов
- Среднее время отклика на проверку доступа

**Алерты:**
- Error rate > 5% в течение 5 минут
- Latency p95 > 3 секунды
- Uptime < 99.9%
- Circuit Breaker в состоянии Open
- Более 10 неуспешных попыток аутентификации за минуту
- Более 100 запросов от одного IP за минуту (возможная атака)

### REQ-MON-003: Security Information and Event Management (SIEM)
**Приоритет:** Средний
**Описание:** Интеграция с SIEM-системой для обнаружения инцидентов безопасности.

**SIEM решения:** Splunk, IBM QRadar, или open-source Wazuh

**Use Cases для детекции:**

**UC-1: Подозрительная активность доступа**
- Множественные попытки доступа с разных устройств одного пользователя одновременно
- Доступ в необычное время (ночью, если обычно днём)
- Частые отказы в доступе с последующим успешным проходом (возможная кража биометрии)

**UC-2: Компрометация API**
- Запросы с валидным токеном, но из неожиданного IP-адреса
- Запросы к множеству building_id с одного токена (попытка перебора)
- Необычно высокий объём запросов от одного клиента

**UC-3: Внутренняя угроза**
- Администратор запрашивает доступ к данным множества пользователей
- Массовое удаление прав доступа
- Экспорт большого объёма данных

**UC-4: Атаки на инфраструктуру**
- DDoS на webhook endpoint
- SQL injection попытки в параметрах запросов
- XSS попытки в полях данных

**Настройка правил корреляции:**
```
RULE: Multiple Failed Auth Attempts
IF (event.type == "authentication_failed" AND
    count(events) > 10 WITHIN 5 minutes FROM same source_ip)
THEN alert(severity=MEDIUM, message="Possible brute-force attack")
```

### REQ-MON-004: Распределённое трассирование (Distributed Tracing)
**Приоритет:** Средний
**Описание:** Возможность отслеживать запросы через все компоненты системы.

**Инструменты:** Jaeger или Zipkin (OpenTelemetry)

**Trace Context:**
```http
traceparent: 00-{trace-id}-{span-id}-{trace-flags}
tracestate: propdevelopment=correlationid:123456
```

**Пример trace:**
```
Trace ID: abc123def456...

Span 1: mobile_app → tenant-core-app (150ms)
  ├─ Span 2: tenant-core-app → tenant-crm (50ms)
  └─ Span 3: tenant-core-app → smart-home-integration (80ms)
      ├─ Span 4: smart-home-integration → API Gateway партнёра (60ms)
      │   └─ Span 5: API Gateway → Biometry Service (45ms)
      └─ Span 6: smart-home-integration → smart-home-db (15ms)
```

**Преимущества:**
- Визуализация всего пути запроса
- Идентификация узких мест (bottlenecks)
- Диагностика ошибок в распределённой системе

---

## Требования к обеспечению доступности

### REQ-AVAIL-001: Service Level Agreement (SLA)
**Приоритет:** Высокий
**Описание:** Определены целевые показатели доступности.

**SLA метрики:**
- **Uptime:** 99.9% (допустимый downtime: 43.2 минуты в месяц)
- **Latency:**
  - p95 < 2 секунды для проверки прав доступа
  - p95 < 5 секунд для создания нового доступа
- **Error Rate:** < 0.1% от всех запросов

**SLA между PropDevelopment и партнёром:**
- Партнёр гарантирует доступность API 99.9%
- PropDevelopment гарантирует отправку webhooks в течение 5 минут после события
- При нарушении SLA - штрафные санкции или компенсации (определяются в контракте)

### REQ-AVAIL-002: Отказоустойчивость (Fault Tolerance)
**Приоритет:** Критический
**Описание:** Система должна продолжать работу при отказе отдельных компонентов.

**Механизмы:**

**1. Кэширование прав доступа (Fallback механизм)**

При недоступности партнёрской платформы:
```
1. smart-home-integration-service имеет локальный кэш прав доступа (smart-home-db)
2. При проверке доступа сначала проверяется кэш
3. Если платформа недоступна (Circuit Breaker Open):
   a. Используются данные из кэша (если не старше 24 часов)
   b. Логируется событие "fallback mode"
   c. Отправляется алерт администраторам
4. Когда платформа восстанавливается:
   a. Синхронизация изменений, произошедших в offline режиме
   b. Обновление кэша
```

**2. Резервный режим для устройств**

Умные домофоны и шлагбаумы должны иметь локальный fallback:
```
- Локальное хранилище биометрических данных на устройстве (ограниченное)
- При недоступности платформы - проверка по локальной базе
- После восстановления связи - синхронизация событий
```

**3. Репликация критических сервисов**

- smart-home-integration-service: минимум 2 инстанса (за балансировщиком)
- event-processor-service: минимум 2 инстанса
- Message Broker: кластер из 3 нод (quorum)
- Базы данных: Master-Slave репликация (PostgreSQL Streaming Replication)

### REQ-AVAIL-003: Disaster Recovery (DR)
**Приоритет:** Высокий
**Описание:** План восстановления при критических сбоях.

**DR Site:**
- Географически удалённый резервный ЦОД
- Асинхронная репликация данных
- Возможность переключения трафика на DR site (failover)

**RTO/RPO:**
- **RTO (Recovery Time Objective):** 4 часа
- **RPO (Recovery Point Objective):** 1 час

**Процедура DR:**
1. Обнаружение критического сбоя (автоматический мониторинг)
2. Оценка ситуации и принятие решения о переключении на DR
3. Активация DR site
4. Переключение DNS на DR инфраструктуру
5. Проверка работоспособности
6. Уведомление пользователей (если требуется)

---

## Требования к управлению инцидентами

### REQ-INC-001: Процедура реагирования на инциденты
**Приоритет:** Высокий
**Описание:** Определён процесс обработки инцидентов безопасности.

**Классификация инцидентов:**

| Уровень | Описание | Примеры | Время реагирования |
|---------|----------|---------|-------------------|
| P0 - Критический | Массовая утечка данных, полная недоступность | Компрометация БД биометрии, DDoS на всю инфраструктуру | 15 минут |
| P1 - Высокий | Утечка конфиденциальных данных, частичная недоступность | Несанкционированный доступ к данным пользователей | 1 час |
| P2 - Средний | Нарушение политик безопасности, деградация сервиса | Обнаружена уязвимость, повышенный error rate | 4 часа |
| P3 - Низкий | Потенциальные угрозы, незначительные проблемы | Подозрительная активность, предупреждения от сканеров | 24 часа |

**Этапы обработки инцидента:**

**1. Обнаружение (Detection)**
- Автоматические алерты от SIEM, мониторинга
- Сообщения от пользователей
- Сообщения от партнёра

**2. Оценка и классификация (Triage)**
- Определение уровня критичности (P0-P3)
- Идентификация затронутых систем и данных
- Оценка масштаба воздействия

**3. Сдерживание (Containment)**
- **Немедленные действия:**
  - Блокировка скомпрометированных учётных записей
  - Отзыв токенов доступа
  - Блокировка IP-адресов атакующих
  - Изоляция затронутых систем
- **Долгосрочные действия:**
  - Патчинг уязвимостей
  - Изменение конфигураций

**4. Искоренение (Eradication)**
- Удаление вредоносного кода (если применимо)
- Закрытие уязвимостей
- Изменение всех скомпрометированных учётных данных

**5. Восстановление (Recovery)**
- Восстановление сервисов из безопасных бэкапов
- Постепенное возвращение систем в production
- Мониторинг на предмет повторных инцидентов

**6. Анализ (Post-Incident Review)**
- Документирование инцидента
- Root Cause Analysis (RCA)
- Разработка мер по предотвращению
- Обновление процедур и runbooks

### REQ-INC-002: Уведомление о нарушениях данных
**Приоритет:** Критический
**Описание:** Процедура уведомления при утечке персональных данных.

**Соблюдение законодательства:**
- **ФЗ-152:** Уведомление Роскомнадзора при инцидентах с ПДн
- **GDPR (если применимо):** Уведомление регулятора в течение 72 часов

**Процедура уведомления:**

**При обнаружении утечки секретных/конфиденциальных данных:**

1. **Немедленно (в течение 1 часа):**
   - Уведомление CISO (Chief Information Security Officer)
   - Формирование инцидент-команды
   - Начало расследования

2. **В течение 24 часов:**
   - Оценка масштаба: количество затронутых пользователей, типы данных
   - Уведомление руководства компании
   - Уведомление юридического отдела

3. **В течение 72 часов:**
   - Уведомление регулятора (Роскомнадзор)
   - Подготовка публичного заявления (если требуется)

4. **В течение 7 дней:**
   - Уведомление затронутых пользователей (если применимо)
   - Предоставление рекомендаций по минимизации ущерба

**Шаблон уведомления пользователя:**
```
Уважаемый {ИМЯ},

Мы хотим проинформировать вас об инциденте безопасности, который произошёл {ДАТА}.

Что произошло:
{КРАТКОЕ ОПИСАНИЕ ИНЦИДЕНТА}

Какие данные затронуты:
{СПИСОК ТИПОВ ДАННЫХ}

Что мы предприняли:
{МЕРЫ ПО УСТРАНЕНИЮ}

Что рекомендуем вам сделать:
- {РЕКОМЕНДАЦИЯ 1}
- {РЕКОМЕНДАЦИЯ 2}

Мы приносим извинения за возможные неудобства.

Контакт для вопросов: security@propdevelopment.com
```

### REQ-INC-003: Контакты для экстренных ситуаций
**Приоритет:** Высокий
**Описание:** Определены контактные лица для экстренных ситуаций.

**Контакты PropDevelopment:**
- **Security Operations Center (SOC):** security-ops@propdevelopment.com, +7-XXX-XXX-XXXX (24/7)
- **CISO:** ciso@propdevelopment.com
- **Technical Lead (Smart Home Integration):** smarthome-lead@propdevelopment.com

**Контакты партнёра:**
- **Security Team:** security@partner-smarthome.com, +7-YYY-YYY-YYYY (24/7)
- **Technical Support:** support@partner-smarthome.com
- **Account Manager:** account-manager@partner-smarthome.com

**Эскалация:**
```
Уровень 1 (L1): Дежурный инженер SOC
    ├─ Не решено за 30 минут → Уровень 2

Уровень 2 (L2): Старший инженер безопасности
    ├─ Не решено за 1 час → Уровень 3

Уровень 3 (L3): CISO + CTO
    ├─ Критический инцидент → Генеральный директор
```

---

## Заключение

Данный документ определяет комплексные требования к безопасности интеграции с внешней платформой "Умный дом". Соблюдение этих требований обеспечит:

1. **Защиту данных:** Секретные и конфиденциальные данные (биометрия, ПДн) защищены на всех этапах
2. **Соответствие законодательству:** Соблюдение ФЗ-152, требований ФСТЭК, ISO 27001/27002
3. **Изоляцию данных:** Партнёр не может получить доступ к данным других жилых комплексов
4. **Отказоустойчивость:** Система продолжает работу при сбоях партнёрской платформы
5. **Видимость:** Полное логирование, мониторинг и трассировка всех операций
6. **Быстрое реагирование:** Процедуры обнаружения и устранения инцидентов

**Регулярный пересмотр:**
Данный документ должен пересматриваться:
- Ежегодно (плановый пересмотр)
- При изменении архитектуры интеграции
- При обнаружении новых угроз или уязвимостей
- После инцидентов безопасности

**Версия документа:** 1.0
**Дата создания:** 2025-10-20
**Дата следующего пересмотра:** 2026-10-20